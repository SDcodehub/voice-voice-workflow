---
# NVIDIA Riva Server Deployment
# Requires GPU nodes and NGC API key
apiVersion: v1
kind: Secret
metadata:
  name: ngc-secret
  namespace: voice-workflow
type: kubernetes.io/dockerconfigjson
data:
  # Base64 encoded Docker config with NGC credentials
  # Replace with: echo -n '{"auths":{"nvcr.io":{"username":"$oauthtoken","password":"<NGC_API_KEY>"}}}' | base64
  .dockerconfigjson: ""
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: riva-config
  namespace: voice-workflow
data:
  # Riva model configuration for Hindi
  model-config.yaml: |
    riva:
      speech_synthesis:
        - model: riva-tts-fastpitch-hi-IN
          language_code: hi-IN
      speech_recognition:
        - model: riva-asr-conformer-hi-IN
          language_code: hi-IN
          enable_automatic_punctuation: true
          enable_word_time_offsets: false
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: riva-server
  namespace: voice-workflow
  labels:
    app: riva-server
    app.kubernetes.io/name: riva-server
    app.kubernetes.io/component: inference
spec:
  replicas: 1
  selector:
    matchLabels:
      app: riva-server
  template:
    metadata:
      labels:
        app: riva-server
    spec:
      imagePullSecrets:
        - name: ngc-secret
      containers:
        - name: riva-server
          image: nvcr.io/nvidia/riva/riva-speech:2.14.0
          ports:
            - containerPort: 50051
              name: grpc
            - containerPort: 8000
              name: http
          env:
            - name: RIVA_API_KEY
              valueFrom:
                secretKeyRef:
                  name: riva-secrets
                  key: api-key
                  optional: true
          resources:
            limits:
              nvidia.com/gpu: 1
              memory: "32Gi"
              cpu: "8"
            requests:
              nvidia.com/gpu: 1
              memory: "16Gi"
              cpu: "4"
          volumeMounts:
            - name: riva-model-repo
              mountPath: /data/models
            - name: riva-config
              mountPath: /config
          livenessProbe:
            grpc:
              port: 50051
            initialDelaySeconds: 300
            periodSeconds: 30
          readinessProbe:
            grpc:
              port: 50051
            initialDelaySeconds: 120
            periodSeconds: 10
      volumes:
        - name: riva-model-repo
          persistentVolumeClaim:
            claimName: riva-models-pvc
        - name: riva-config
          configMap:
            name: riva-config
      nodeSelector:
        nvidia.com/gpu.present: "true"
      tolerations:
        - key: nvidia.com/gpu
          operator: Exists
          effect: NoSchedule
---
apiVersion: v1
kind: Service
metadata:
  name: riva-server
  namespace: voice-workflow
  labels:
    app: riva-server
spec:
  type: ClusterIP
  ports:
    - port: 50051
      targetPort: 50051
      name: grpc
    - port: 8000
      targetPort: 8000
      name: http
  selector:
    app: riva-server
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: riva-models-pvc
  namespace: voice-workflow
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 100Gi
  storageClassName: standard  # Adjust based on your cluster

